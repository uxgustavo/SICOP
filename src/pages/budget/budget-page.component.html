<div class="flex-1 overflow-y-auto p-6 md:px-10 md:py-8 h-full relative">
  
  <!-- Header & Controls -->
  <div class="flex flex-col gap-6 mb-8">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">Dotações Orçamentárias</h1>
        <p class="text-sm text-gray-500 mt-1">Gestão de saldos vinculados aos contratos da aplicação.</p>
      </div>
      
      <!-- Layout Toggle -->
      <div class="flex bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm p-0.5 self-start md:self-auto">
        <button 
          (click)="setLayoutMode('grid')"
          class="p-1.5 rounded transition-colors"
          [class]="layoutMode() === 'grid' 
            ? 'text-sco-blue bg-blue-50 dark:bg-blue-900/30 dark:text-blue-300' 
            : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700'"
          title="Grade"
        >
          <span class="material-symbols-outlined text-[20px]">grid_view</span>
        </button>
        <button 
          (click)="setLayoutMode('list')"
          class="p-1.5 rounded transition-colors"
          [class]="layoutMode() === 'list' 
            ? 'text-sco-blue bg-blue-50 dark:bg-blue-900/30 dark:text-blue-300' 
            : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700'"
          title="Lista"
        >
          <span class="material-symbols-outlined text-[20px]">view_list</span>
        </button>
      </div>
    </div>

    <!-- Toolbar: Search & Filter Toggle -->
    <div class="flex gap-4">
      <!-- Search -->
      <div class="relative flex-1 max-w-lg">
        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[20px]">search</span>
        <input 
          (input)="updateSearch($event)"
          [value]="searchQuery()"
          class="w-full pl-10 pr-4 py-3 text-sm bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-sco-blue focus:border-sco-blue outline-none transition-all shadow-sm" 
          placeholder="Buscar dotação, contrato ou SEI..." 
          type="text"
        />
      </div>

      <!-- Filter Toggle Button -->
      <button 
        (click)="toggleFilterPanel()"
        class="flex items-center gap-2 px-4 py-3 text-sm font-medium rounded-xl border transition-all shadow-sm"
        [class]="isFilterPanelOpen() || filterUnit() !== 'ALL' || filterNoBalance() || filterMinBalance() !== null
          ? 'bg-blue-50 border-blue-200 text-sco-blue dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-300' 
          : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-300'"
      >
        <span class="material-symbols-outlined text-[20px]">tune</span>
        Filtros
        @if (filterUnit() !== 'ALL' || filterNoBalance() || filterMinBalance() !== null) {
          <span class="flex h-2 w-2 rounded-full bg-sco-blue"></span>
        }
      </button>
    </div>
  </div>

  <!-- Advanced Filter Panel -->
  @if (isFilterPanelOpen()) {
    <div class="mb-8 p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg animate-in fade-in slide-in-from-top-4 duration-200">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white flex items-center gap-2">
          <span class="material-symbols-outlined text-sco-blue">filter_alt</span>
          Filtros Avançados
        </h3>
        <button (click)="clearFilters()" class="text-xs text-red-500 hover:text-red-700 font-medium hover:underline">
          Limpar Filtros
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Unit Filter -->
        <div class="space-y-3">
          <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Unidade Gestora</label>
          <select 
            [ngModel]="filterUnit()"
            (ngModelChange)="filterUnit.set($event)"
            class="w-full px-3 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-sco-blue outline-none"
          >
            <option value="ALL">Todas</option>
            <option value="FADEP">FADEP</option>
            <option value="DEFENSORIA">DEFENSORIA</option>
          </select>
        </div>

        <!-- Balance Below X -->
        <div class="space-y-3">
          <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Saldo Abaixo De (R$)</label>
          <input 
            type="number" 
            [ngModel]="filterMinBalance()"
            (ngModelChange)="filterMinBalance.set($event)"
            placeholder="Ex: 1000"
            class="w-full px-3 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-sco-blue outline-none"
          >
        </div>

        <!-- No Balance Checkbox -->
        <div class="space-y-3 flex flex-col justify-end">
          <label class="flex items-center gap-2 cursor-pointer p-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
            <input 
              type="checkbox" 
              [ngModel]="filterNoBalance()"
              (ngModelChange)="filterNoBalance.set($event)"
              class="rounded border-gray-300 text-red-500 focus:ring-red-500"
            >
            <span class="text-sm text-gray-700 dark:text-gray-300 font-medium">Apenas Sem Saldo</span>
          </label>
        </div>
      </div>
    </div>
  }

  <!-- Content: Grid or List -->
  @if (filteredDotacoes().length > 0) {
    
    @if (layoutMode() === 'grid') {
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-10">
        @for (item of filteredDotacoes(); track item.id) {
          <div 
            (click)="openDetails(item)"
            class="bg-white dark:bg-card-dark rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-lg hover:border-sco-blue/50 dark:hover:border-sco-blue/50 transition-all cursor-pointer flex flex-col group h-full relative overflow-hidden"
          >
            <div class="p-6 flex flex-col h-full">
              <!-- Header -->
              <div class="mb-4">
                <span 
                  class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider mb-2 border"
                  [class]="getBadgeClass(item.unidadeOrcamentaria)"
                >
                  {{ item.unidadeOrcamentaria }}
                </span>
                <h3 class="text-base font-bold text-gray-900 dark:text-white leading-tight group-hover:text-sco-blue transition-colors">
                  {{ item.descricao }}
                </h3>
              </div>

              <!-- Contract Info (Split Fields) -->
              <div class="mb-6 space-y-3">
                <!-- Contract Number Field -->
                <div class="flex flex-col">
                  <span class="text-xs text-gray-400 font-semibold uppercase">Contrato</span>
                  <span class="text-sm font-medium text-gray-700 dark:text-gray-300 font-mono">
                    Contrato {{ getContract(item.contractId)?.number || '---' }}
                  </span>
                </div>
                
                <!-- Supplier Name Field (New) -->
                <div class="flex flex-col">
                  <span class="text-xs text-gray-400 font-semibold uppercase">Contratada</span>
                  <span class="text-sm font-medium text-gray-700 dark:text-gray-300 line-clamp-1" [title]="getContract(item.contractId)?.supplierName">
                    {{ getContract(item.contractId)?.supplierName || '---' }}
                  </span>
                </div>

                <div class="flex flex-col">
                  <span class="text-xs text-gray-400 font-semibold uppercase">CNPJ</span>
                  <span class="text-sm font-mono text-gray-600 dark:text-gray-400">{{ item.cnpj }}</span>
                </div>
              </div>

              <!-- Footer Financials -->
              <div class="mt-auto pt-4 border-t border-gray-100 dark:border-gray-700 grid grid-cols-2 gap-4">
                <div>
                  <span class="text-xs text-gray-400 block mb-0.5">Valor Total</span>
                  <span class="text-sm font-bold text-gray-900 dark:text-white">
                    {{ item.valorTotal | currency:'BRL':'symbol':'1.2-2' }}
                  </span>
                </div>
                <div class="text-right">
                  <span class="text-xs text-gray-400 block mb-0.5">Saldo Disponível</span>
                  <span class="text-sm font-bold" [class]="getBalanceColor(item)">
                    {{ calcSaldo(item) | currency:'BRL':'symbol':'1.2-2' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    } @else {
      <!-- List View -->
      <div class="bg-white dark:bg-card-dark rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden pb-0 mb-10">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-100 dark:divide-gray-800">
            <thead>
              <tr class="bg-gray-50/50 dark:bg-gray-800/50">
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">Dotação</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">Contrato</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">Contratada</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">CNPJ</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">Unidade</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">Saldo</th>
                <th class="px-6 py-4 text-right text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">Ações</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
              @for (item of filteredDotacoes(); track item.id) {
                <tr class="group hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                  <td class="px-6 py-4 whitespace-nowrap">
                     <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ item.descricao }}</span>
                  </td>
                  <!-- Contrato Column -->
                  <td class="px-6 py-4 whitespace-nowrap">
                     <span class="text-sm font-mono font-medium text-gray-700 dark:text-gray-300">
                       Contrato {{ getContract(item.contractId)?.number }}
                     </span>
                  </td>
                  <!-- Contratada Column (New) -->
                  <td class="px-6 py-4">
                     <span class="text-sm text-gray-700 dark:text-gray-300 line-clamp-2 max-w-[200px]" [title]="getContract(item.contractId)?.supplierName">
                       {{ getContract(item.contractId)?.supplierName }}
                     </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                     <span class="text-sm font-mono text-gray-600 dark:text-gray-400">{{ item.cnpj }}</span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                     <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold border shadow-sm" [class]="getBadgeClass(item.unidadeOrcamentaria)">
                      {{ item.unidadeOrcamentaria }}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm font-bold" [class]="getBalanceColor(item)">
                      {{ calcSaldo(item) | currency:'BRL':'symbol':'1.2-2' }}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right">
                    <button 
                      (click)="openDetails(item)"
                      class="text-gray-400 hover:text-sco-blue transition-colors p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"
                    >
                      <span class="material-symbols-outlined text-[20px]">visibility</span>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }

  } @else {
    <!-- Empty State -->
    <div class="flex flex-col items-center justify-center py-16 text-gray-400">
      <span class="material-symbols-outlined text-5xl mb-3 opacity-50">search_off</span>
      <p class="text-lg font-medium text-gray-600 dark:text-gray-300">Nenhuma dotação encontrada</p>
      <p class="text-sm mb-6">Tente ajustar os filtros ou buscar por outro termo.</p>
      <button 
        (click)="clearFilters()"
        class="text-sco-blue hover:underline font-medium"
      >
        Limpar todos os filtros
      </button>
    </div>
  }

  <!-- Side Panel / Drawer for Details -->
  @if (selectedBudget()) {
    <div class="fixed inset-0 z-50 flex justify-end" role="dialog" aria-modal="true">
      
      <!-- Backdrop -->
      <div 
        class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity animate-in fade-in duration-200"
        (click)="closeDetails()"
      ></div>

      <!-- Panel -->
      <div class="relative w-full max-w-xl bg-white dark:bg-card-dark h-full shadow-2xl flex flex-col animate-in slide-in-from-right duration-300">
        
        <!-- Panel Header -->
        <div class="px-6 py-5 border-b border-gray-100 dark:border-gray-700 bg-white dark:bg-card-dark flex items-center justify-between shrink-0">
          <div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white tracking-tight">Detalhes da Dotação</h2>
            <p class="text-sm text-gray-500 font-mono mt-0.5 flex items-center gap-2">
               <span class="material-symbols-outlined text-[16px]">folder_open</span>
               {{ selectedBudget()?.linkSei }}
            </p>
          </div>
          <button 
            (click)="closeDetails()" 
            class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        <!-- Panel Content -->
        <div class="flex-1 overflow-y-auto p-6">
          
          <!-- Summary Card in Panel -->
          <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-5 border border-gray-200 dark:border-gray-700 mb-6">
            
            <!-- Icon & Title -->
            <div class="flex gap-4 mb-5">
               <div class="h-10 w-10 rounded-lg flex items-center justify-center bg-white dark:bg-gray-700 shadow-sm text-sco-blue dark:text-white shrink-0 border border-gray-100 dark:border-gray-600">
                <span class="material-symbols-outlined text-[20px]">assignment</span>
              </div>
              <div class="flex-1 pt-0.5">
                <h3 class="font-bold text-gray-900 dark:text-white text-base leading-snug mb-0.5">{{ selectedBudget()?.descricao }}</h3>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wide border shadow-sm" [class]="getBadgeClass(selectedBudget()!.unidadeOrcamentaria)">
                  {{ selectedBudget()?.unidadeOrcamentaria }}
                </span>
              </div>
            </div>

            <!-- Contract Details Grid -->
            <div class="grid grid-cols-[100px_1fr] gap-y-2 items-baseline mb-5">
                
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Contrato</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">
                    {{ getContract(selectedBudget()!.contractId)?.number }}
                </span>

                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Fornecedor</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white leading-tight truncate">
                    {{ getContract(selectedBudget()!.contractId)?.supplierName }}
                </span>

                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">CNPJ</span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">
                    {{ selectedBudget()?.cnpj }}
                </span>

            </div>

            <div class="border-t border-gray-200 dark:border-gray-700 my-5"></div>

            <!-- Financials -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <span class="text-xs text-gray-500 uppercase font-bold tracking-wide block mb-1">Total Aprovado</span>
                <p class="text-lg font-bold text-gray-900 dark:text-white">
                  {{ selectedBudget()?.valorTotal | currency:'BRL':'symbol':'1.2-2' }}
                </p>
              </div>
              <div>
                <span class="text-xs text-gray-500 uppercase font-bold tracking-wide block mb-1">Valor Utilizado</span>
                <p class="text-lg font-bold text-gray-600 dark:text-gray-400">
                  {{ selectedBudget()?.valorUtilizado | currency:'BRL':'symbol':'1.2-2' }}
                </p>
              </div>
              <div class="col-span-2 pt-2">
                 <div class="flex justify-between items-end mb-2">
                    <span class="text-xs text-gray-500 uppercase font-bold tracking-wide">Saldo Atual</span>
                    <span class="text-xl font-bold" [class]="selectedBudget() ? getBalanceColor(selectedBudget()!) : ''">
                      {{ calcSaldo(selectedBudget()!) | currency:'BRL':'symbol':'1.2-2' }}
                    </span>
                 </div>
                 <!-- Progress Bar -->
                 <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                   <div 
                      class="h-2 rounded-full transition-all duration-500"
                      [class]="((selectedBudget()?.valorUtilizado || 0) / (selectedBudget()?.valorTotal || 1)) > 0.8 ? 'bg-red-500' : 'bg-green-500'"
                      [style.width.%]="(calcSaldo(selectedBudget()!) / (selectedBudget()?.valorTotal || 1)) * 100"
                   ></div>
                 </div>
              </div>
            </div>
          </div>

          <!-- History List -->
          <div class="mb-4 flex items-center justify-between">
             <h3 class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wider flex items-center gap-2">
                <span class="material-symbols-outlined text-[18px] text-gray-400">history</span>
                Histórico Financeiro
             </h3>
             <span class="text-[10px] font-medium text-gray-500 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded-full">{{ selectedBudgetHistory().length }} lançamentos</span>
          </div>

          @if (selectedBudgetHistory().length > 0) {
            <div class="relative border-l-2 border-gray-100 dark:border-gray-800 ml-3 space-y-6 pb-6">
              @for (transaction of selectedBudgetHistory(); track transaction.id) {
                <div class="relative pl-6">
                  <!-- Timeline Dot -->
                  <div 
                    class="absolute -left-[9px] top-1.5 h-4 w-4 rounded-full border-2 border-white dark:border-card-dark shadow-sm ring-2 ring-gray-50 dark:ring-gray-800"
                    [class]="transaction.type === 'LIQUIDATION' ? 'bg-red-500' : (transaction.type === 'COMMITMENT' ? 'bg-green-500' : 'bg-blue-500')"
                  ></div>

                  <div class="flex flex-col gap-1.5 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                      <span 
                        class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase border"
                        [class]="getTypeClass(transaction.type)"
                      >
                        {{ getTypeLabel(transaction.type) }}
                      </span>
                      <span class="text-[11px] font-medium text-gray-400">{{ transaction.date | date:'dd/MM/yyyy' }}</span>
                    </div>
                    
                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white mt-0.5">
                      {{ transaction.description }}
                    </h4>
                    
                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-50 dark:border-gray-700">
                      <div class="flex items-center gap-1.5">
                         <span class="material-symbols-outlined text-[14px] text-gray-300">tag</span>
                         <span class="text-xs text-gray-500 font-mono">
                            {{ transaction.commitmentId }}
                         </span>
                      </div>
                      <span class="text-sm font-bold text-gray-900 dark:text-white">
                        R$ {{ transaction.amount | number:'1.2-2':'pt-BR' }}
                      </span>
                    </div>
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="text-center py-8 text-gray-400 bg-gray-50 dark:bg-gray-800/30 rounded-lg border border-dashed border-gray-200 dark:border-gray-700">
              <span class="material-symbols-outlined text-3xl mb-1 opacity-50">receipt_long</span>
              <p class="text-xs">Nenhum lançamento registrado.</p>
            </div>
          }

        </div>
      </div>
    </div>
  }
</div>